# 1. Setup Variables
export PROJECT_ID=handwriting-synthesis-446922
TOKEN=$(gcloud auth print-access-token)

# 2. Set Window (Last 7 Days)
# We focus on the last week to get a representative sample
END_TIME=$(date -u -d '1 day ago' +%FT%TZ)
START_TIME=$(date -u -d '8 days ago' +%FT%TZ)

echo "Step 1: Building Machine Type Dictionary..."
gcloud compute machine-types list --filter="zone:(us-central1-a)" --format="json(name, guestCpus, memoryMb)" > machine_types.json

echo "Step 2: Fetching Instance Inventory..."
gcloud compute instances list --format="json(id, machineType)" > instances.json

echo "Step 3: Fetching All Critical Metrics..."

# --- THE UPDATE: Multi-Metric Filter ---
# We use OR logic to request multiple metrics at once.
# Note: We group them with parentheses.
FILTER='metric.type = "compute.googleapis.com/instance/cpu/utilization" OR metric.type = "agent.googleapis.com/memory/percent_used" OR metric.type = "compute.googleapis.com/instance/disk/read_bytes_count" OR metric.type = "compute.googleapis.com/instance/disk/write_bytes_count" OR metric.type = "compute.googleapis.com/instance/network/sent_bytes_count" OR metric.type = "compute.googleapis.com/instance/network/received_bytes_count"'

# We use ALIGN_MEAN to get the "Average utilization/throughput per day"
curl -s -G -H "Authorization: Bearer $TOKEN" \
    "https://monitoring.googleapis.com/v3/projects/$PROJECT_ID/timeSeries" \
    --data-urlencode "filter=$FILTER" \
    --data-urlencode "interval.startTime=$START_TIME" \
    --data-urlencode "interval.endTime=$END_TIME" \
    --data-urlencode "aggregation.perSeriesAligner=ALIGN_MEAN" \
    --data-urlencode "aggregation.alignmentPeriod=86400s" \
| jq -r --slurpfile instances instances.json --slurpfile types machine_types.json '
    ($types[0] | map({key: .name, value: {cpu: .guestCpus, mem: .memoryMb}}) | from_entries) as $spec_map |
    ($instances[0] | map({key: .id, value: (.machineType | split("/") | last)}) | from_entries) as $inst_map |
    
    if .error then error("API Error: " + .error.message) else . end |
    
    ["Metric Name", "Instance ID", "Machine Type", "vCPUs", "Memory (GB)", "Avg Value", "Timestamp"],
    
    (.timeSeries[]? | 
        .resource.labels.instance_id as $id |
        ($inst_map[$id] // "Unknown") as $type |
        
        # Smart Parsing for Specs
        ($spec_map[$type] // 
            (if ($type | contains("custom")) then 
                ($type | split("-")) as $parts | { cpu: ($parts[-2] | tonumber), mem: ($parts[-1] | tonumber) }
             else {cpu: "N/A", mem: 0} end)
        ) as $specs |

        [
            .metric.type,
            $id,
            $type,
            $specs.cpu,
            ($specs.mem / 1024), 
            (.points[0].value.doubleValue // .points[0].value.int64Value), 
            .points[0].interval.endTime
        ]
    ) 
    | @csv' > ops_audit_complete.csv

echo "Success! Report Generated."
echo "Previewing first 10 rows:"
echo "-------------------------"
cat ops_audit_complete.csv | head -n 10
